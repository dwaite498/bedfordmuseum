---
- become: yes
  gather_facts: no
  hosts: all
  remote_user: deploy
  vars_files:
    - resources/secrets.yml
    - resources/vars.yml
  vars:
    docker_env:
      ENVIRONMENT: production
      SERVER_NAME: .bedfordvamuseum.org
      PORT: 80
      CONFIG_DIR: /home/deploy/config
      DATA_DIR: "{{ mount_point }}"
  tasks:
    - name: Create data directories
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ mount_point }}/db"
        - "{{ mount_point }}/rails/public/system"
    - name: Copy deploy files
      copy:
        src: "{{ lookup('env','DEPLOY_FILES_DIR') }}/"
        dest: /home/deploy/
    - name: Stop containers
      docker_service:
        project_src: .
        state: absent
        build: no
      environment: "{{ docker_env }}"
    - name: Load new bedford_rails image
      docker_image:
        load_path: /home/deploy/bedford_rails.tar
        name: bedford_rails
        force: yes
    - name: Run containers
      docker_service:
        project_src: .
        build: no
      environment: "{{ docker_env }}"
    - name: Delete bedford_rails.tar
      file:
        path: /home/deploy/bedford_rails.tar
        state: absent
